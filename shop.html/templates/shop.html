<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome Webstore</title>
    <style>
        /* General Styling */
        :root {
            /* Modern & Premium Theme (Default) */
            --c-bg: #e9ecef;
            --c-text: #212529;
            --c-text-secondary: #6c757d;
            --c-header-bg: #ffffff;
            --c-header-text: #212529;
            --c-card-bg: #ffffff;
            --c-card-text: #212529;
            --c-accent: #0d6efd; /* Classic Blue */
            --c-accent-darker: #0b5ed7;
            --c-border: #dee2e6;
            --c-shadow: rgba(0, 0, 0, 0.1);
            --c-input-bg: #e9ecef;
            --c-input-text: #212529;
            --c-header-bg-translucent: rgba(255, 255, 255, 0.85);
            --c-input-focus-bg: #ffffff;
            --c-scroll-btn-bg: rgba(255, 255, 255, 0.9);
            --c-row-bg-alt: #f0f6ff; /* A light blue for alternating rows */
        }

        body.dark-theme {
            /* Modern Dark Theme */
            --c-bg: #121212;
            --c-text: #e9ecef;
            --c-text-secondary: #adb5bd;
            --c-header-bg: #1c1c1c;
            --c-header-text: #e9ecef;
            --c-card-bg: #1c1c1c;
            --c-card-text: #e9ecef;
            --c-accent: #3b82f6; /* A nice blue for dark mode */
            --c-accent-darker: #2563eb;
            --c-border: #343a40;
            --c-shadow: rgba(0, 0, 0, 0.25);
            --c-input-bg: #2c2c2c;
            --c-input-text: #e9ecef;
            --c-header-bg-translucent: rgba(28, 28, 28, 0.85);
            --c-input-focus-bg: #343a40;
            --c-scroll-btn-bg: rgba(28, 28, 28, 0.9);
            --c-row-bg-alt: var(--c-card-bg); /* Keep dark theme subtle */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--c-bg);
            color: var(--c-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Add padding to body to make space for the side/bottom toolbar */
        body {
            padding-left: 60px; /* Space for desktop side toolbar */
            transition: padding-left 0.3s ease, padding-bottom 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1, h2, h3 {
            color: var(--c-text);
        }

        a {
            color: var(--c-accent);
            text-decoration: none;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Header */
        header {
            background-color: var(--c-header-bg-translucent);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            color: var(--c-header-text);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 999;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease;
            box-shadow: 0 1px 3px var(--c-shadow);
        }


        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header.header--hidden {
            transform: translateY(-100%);
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 40px;
            width: auto;
            margin: 0;
            border-radius: 9px;
        }

        header nav ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: flex;
            gap: 20px;
        }

        header nav a,
        header nav button {
            color: var(--c-header-text);
            font-weight: bold;
            transition: color 0.3s ease;
            /* Reset button-specific styles to make it look like a link */
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            cursor: pointer;
        }

        header nav a:hover,
        header nav button:hover {
            color: var(--c-accent);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        #search-bar {
            width: 100%;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--c-border);
            background-color: var(--c-input-bg);
            color: var(--c-input-text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #search-bar:focus {
            outline: none;
            background-color: var(--c-input-focus-bg);
            border-color: var(--c-accent);
        }

        .cancel-search-btn {
            display: none; /* Hidden by default */
            background: none;
            border: none;
            color: var(--c-text-secondary);
            cursor: pointer;
            padding: 0 0.75rem; /* Adjusted for an icon */
            transition: color 0.2s ease;
        }

        .cancel-search-btn:hover {
            color: var(--c-accent);
        }

        .search-popup {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 100%;
            background-color: var(--c-card-bg);
            border: 1px solid var(--c-border);
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            padding: 1.5rem 2rem;
            z-index: 110;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .search-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .search-popup h4 { margin: 0 0 0.5rem 0; }
        .search-popup ul { list-style: none; margin: 0; padding: 0; }
        .search-popup li a { display: block; padding: 0.25rem 0; color: var(--c-text-secondary); transition: color 0.2s ease; }
        .search-popup li a:hover { color: var(--c-accent); }

        /* Category Scroller */
        .category-scroller {
            padding: 1rem 0;
            background-color: var(--c-card-bg);
            border-bottom: 1px solid var(--c-border);
            overflow: hidden;
            white-space: nowrap;
        }

        .scroller-track {
            display: inline-block;
            animation: scroll 80s linear infinite;
        }

        .category-scroller:hover .scroller-track {
            animation-play-state: paused;
        }

        .category-btn {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            margin: 0 0.5rem;
            border: 1px solid var(--c-border);
            border-radius: 20px;
            background-color: transparent;
            color: var(--c-text);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            background-color: var(--c-accent);
            color: white;
            border-color: var(--c-accent);
            transform: translateY(-2px);
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .header-actions {
            display: none;
            align-items: center;
            gap: 3rem;
        }

        /* Settings Menu Button (Mobile) */
        .settings-menu-btn {
            display: none; /* Hidden on desktop */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 1001;
        }

        .settings-menu-btn svg {
            stroke: var(--c-header-text);
            width: 30px;
            height: 30px;
        }
        
        .search-icon-mobile {
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Main Content */
        h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.2rem;
        }

        /* Featured Product Carousel */
        .featured-products {
            margin-top: 1rem;
        }

        .carousel-container {
            max-width: 1200px; /* Made larger to fill container width */
            margin: 0 auto; /* This was changed from 1rem to 2rem in a previous step, but was reverted. Let's keep it at 2rem for consistency */
            overflow: hidden;
            position: relative;
            border-radius: 4px;
            box-shadow: 0 4px 15px var(--c-shadow);
        }

        .carousel-controls {
            position: absolute;
            top: 50%;
            left: 15px;
            right: 15px;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            z-index: 3;
            pointer-events: none; /* So they don't block clicks on the carousel itself if needed */
        }

        .carousel-btn {
            pointer-events: all; /* Re-enable pointer events for buttons */
            background-color: var(--c-scroll-btn-bg);
            border: 1px solid transparent;
            color: var(--c-text);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-btn:hover {
            background-color: var(--c-accent);
            color: white;
            transform: scale(1.1);
        }

        .carousel-pagination {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 3;
        }

        .pagination-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-dot.active {
            background-color: white;
            transform: scale(1.2);
        }

        .carousel-slider {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-item {
            min-width: 100%;
            position: relative;
            aspect-ratio: 22 / 9;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            text-align: left;
            color: white;
            overflow: hidden;
        }

        .carousel-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 40%, rgba(0,0,0,0.8) 100%);
            z-index: 1;
        }

        .carousel-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Changed from 'cover' to 'contain'. This ensures the entire image is visible
               without being cropped or stretched, which can improve perceived quality if the
               source image aspect ratio doesn't match the container. */
            object-fit: cover;
            z-index: 0;
        }

        .carousel-caption {
            position: relative;
            z-index: 2;
            padding: 40px 40px 30px; /* Moved text down by reducing bottom padding */
            max-width: 60%;
        }

        .carousel-caption h3 {
            margin: 0 0 0.5rem 0;
            color: white;
            font-size: 2.2rem; /* Reduced font size */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .carousel-caption p {
            margin: 0;
            font-size: 1rem; /* Reduced font size */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease 0.2s, transform 0.6s ease 0.2s; /* Staggered animation */
        }

        /* Animation for active slide's caption */
        .carousel-item.active .carousel-caption h3,
        .carousel-item.active .carousel-caption p {
            opacity: 1;
            transform: translateY(0);
        }


        /* Product Row (for horizontal scrolling) */
        .product-row {
            padding: 3rem 0;
        }

        .product-row-header {
            display: flex;
            align-items: center;
        }

        .product-row-header h2 {
            margin: 0;
            text-align: left;
        }

        /* Add background to alternating product rows for visual separation */
        #product-sections-container > .product-row:nth-of-type(even) {
            background-color: var(--c-row-bg-alt);
        }

        .product-grid-container {
            position: relative;
        }

        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--c-scroll-btn-bg);
            border: 1px solid var(--c-border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            font-size: 2rem;
            line-height: 42px; /* Vertically center icon */
            text-align: center;
            color: var(--c-text);
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .scroll-btn.prev {
            left: -22px;
        }
        .scroll-btn.next {
            right: -22px;
        }

        .scroll-btn:hover {
            background-color: var(--c-accent);
            color: white;
            border-color: var(--c-accent);
            transform: translateY(-50%) scale(1.05);
        }

        .toolbar-badge {
            position: absolute;
            top: 6px; /* Shifted away from the icon's center */
            right: 6px; /* Shifted away from the icon's center */
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px; /* Fixed width for a perfect circle */
            height: 20px; /* Fixed height for a perfect circle */
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-shadow: 0 0 0 2px var(--c-header-bg);
        }

        /* Side Toolbar */
        .side-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 60px;
            background-color: var(--c-header-bg);
            border-right: 1px solid var(--c-border);
            z-index: 1000; /* Above content, below overlays */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0;
            box-shadow: 1px 0 5px var(--c-shadow);
            transition: all 0.3s ease;
        }

        .side-toolbar > * {
            /* margin-bottom: 1.75rem; */ /* Add space between toolbar items */
        }

        .side-toolbar .toolbar-logo {
            /* Gap is now handled by the parent flex container */
        }

        .side-toolbar .toolbar-logo img {
            height: 35px;
            width: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .toolbar-item {
            background: none;
            border: none;
            color: var(--c-text-secondary);
            cursor: pointer;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: color 0.2s ease;
            position: relative;
            margin-top: 17px;
        } 
        
        .toolbar-item:hover {
            color: var(--c-accent); /* Use the main theme accent for hover */
        }

        .toolbar-item svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }

        .account-button {
            display: none; /* Hidden by default (on desktop) */
        }

        .toolbar-item.settings {
            margin-top: auto; /* Pushes settings to the bottom */
            margin-bottom: 0; /* Remove bottom margin from the last item */
            position: absolute;
            bottom: 5%;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc(25% - 1.5rem); /* 4 items on desktop */
            gap: 2rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 1.5rem; /* Extra space for shadow and breathing room */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .product-grid::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }

        .product-card {
            background-color: var(--c-card-bg);
            border-radius: 12px; /* Slightly more rounded */
            overflow: hidden;
            box-shadow: 0 2px 5px var(--c-shadow);
            display: flex;
            flex-direction: column;
            padding-bottom: 0.75rem; /* Reduced bottom padding */
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px var(--c-shadow);
        }

        .product-card img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }

        /* Desktop Title Marquee Styles */
        .product-name-desktop {
            overflow: hidden; /* This will contain the scrolling text */
            margin: 0.5rem 1rem 0; /* This was on the h3, move it to the wrapper */
        }

        .product-name-desktop h3 {
            margin: 0; /* Reset margin as it's now on the wrapper */
            font-size: 1.2rem;
            color: var(--c-card-text);
            display: inline-flex; /* Use flex to ensure spans stay in a single line */
            white-space: nowrap; /* Prevent text within spans from wrapping */
            /* Truncate by default if not scrolling */
            text-overflow: ellipsis;
            overflow: hidden;
            width: 100%;
        }

        .product-name-desktop h3.is-scrolling {
            animation: marquee 8s linear infinite;
            text-overflow: clip; /* Remove ellipsis when animating */
            width: auto; /* Allow it to be wider than the container for animation */
        }

        .product-card h3 {
            /* Base styles are now in .product-name-desktop h3 */
            /* This selector is kept for specificity and potential overrides */
        }
        
        .product-card .product-description {
            font-size: 0.9rem;
            margin: 0 1rem 0rem; /* Removed top margin, reduced bottom margin */
            color: var(--c-text-secondary);
            flex-grow: 1; /* Pushes price and button to the bottom */
            /* Truncate description to 2 lines to keep card height consistent */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.88rem; /* (font-size * line-height * lines) -> 0.9rem * 1.6 * 2 */
        }

        .product-card .product-price-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 1rem 0; /* Removed bottom margin, handled by card padding now */
            gap: 0.5rem;
        }

        /* Hide mobile-only elements on desktop by default */
        .product-name-mobile {
            display: none;
        }

        .product-card .product-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--c-accent);
            margin: 0; /* Moved to price-line container */
        }

        .product-card .product-location {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--c-text-secondary);
            flex-shrink: 0;
        }
        .product-card .product-location svg {
            width: 14px;
            height: 14px;
            fill: #dc3545;
        }

        /* Footer */
        footer {
            background-color: var(--c-header-bg);
            color: var(--c-header-text);
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }

        /* =================================== */
        /*      Mobile Responsiveness        */
        /* =================================== */
        @media (max-width: 992px) {
            .search-container {
                order: 3; /* Move search bar below nav on medium screens */
                flex-basis: 100%;
                margin: 1rem 0 0 0;
            }
        }

        @media (max-width: 768px) {
            /* Adjust body padding for bottom bar on mobile */
            body {
                padding-left: 0;
                padding-bottom: 45px; /* Adjusted space for a sleeker bottom toolbar */
            }

            /* Make mobile header consistent with bottom bar (blurry) */
            header {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                background-color: var(--c-header-bg-translucent);
                -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
            }

            main .container {
                padding-left: 0;
                padding-right: 0;
            }

            header .container {
                flex-wrap: wrap;
            }

            nav#main-nav {
                display: none; /* Hide nav by default */
                flex-basis: 100%; /* Take full width */
                margin-top: 1rem;
            }

            nav#main-nav.nav-open {
                display: block; /* Show nav when toggled */
            }

            header nav ul {
                flex-direction: column;
                gap: 0;
                align-items: center;
            }

            header nav li {
                width: 100%;
                text-align: center;
            }

            header nav a {
                padding: 0.6rem 1rem;
                display: block;
                border-bottom: 1px solid var(--c-border);
            }
            
            header nav li:first-child a {
                border-top: 1px solid var(--c-border);
            }

            /* Category Scroller on Mobile */
            .category-scroller {
                padding: 0.6rem 20px; /* Reduce vertical space and add horizontal padding */
                clip-path: inset(0); /* Ensures the animation doesn't show outside the container with padding */
                border-bottom: none; /* Remove border to make it feel more integrated */
            }

            .category-btn {
                padding: 0.3rem 0.9rem; /* Smaller buttons */
                font-size: 0.85rem; /* Smaller text */
            }

            h2 { font-size: 1.3rem; }

            .carousel-controls {
                display: none; /* Hide arrows on mobile, rely on swipe */
            }

            .carousel-item {
                aspect-ratio: 16 / 9;
            }

            .carousel-caption {
                padding: 10px;
                max-width: 90%;
                padding-bottom: 40px; /* Space for pagination dots */
            }

            .carousel-caption h3 {
                font-size: 1.4rem;
            }
            .carousel-caption p {
                font-size: 0.9rem;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .search-container {
                display: none; /* Hide desktop search bar */
            }

            /* Mobile Search Active State */
            header.search-mode-on .logo,
            header.search-mode-on .header-actions {
                display: none;
            }

            header.search-mode-on .search-container {
                display: flex;
                flex-grow: 1;
                margin: 0;
            }

            header.search-mode-on .search-popup {
                display: none; /* Hide popup suggestions in mobile search mode */
            }

            header.search-mode-on .cancel-search-btn {
                display: flex; align-items: center; justify-content: center;
            }

            .header-actions {
                display: flex; /* Show mobile action icons */
            }

            .settings-menu-btn {
                display: block; /* Show on mobile */
            }

            .logo {
                /* Re-enabling the logo to correctly position the header items. */
            }

            .logo img {
                height: 35px; /* Slightly smaller logo */
            }

            /* Horizontal scroll on mobile */
            .scroll-btn {
                display: none; /* Hide scroll buttons on mobile, rely on swipe */
            }

            .product-row {
                padding: 0rem 0;
            }

            .product-row-header {
                /* Add padding to align the section title with the product grid below */
                padding: 0 20px;
            }

            /* Overhaul mobile product card for better consistency and responsiveness */
            .product-card {
                height: auto; /* Remove fixed height */
                border: solid var(--c-border) 0.1px;
                border-radius: 9px;
                padding-bottom: 0.15rem;
            }

            /* Mobile Toolbar (Bottom) */
            .side-toolbar {
                top: auto;
                bottom: 0;
                width: 100%;
                height: 45px; /* Reduced height for a sleeker look */
                flex-direction: row;
                border-radius: 9px 9px 0px 0px;
                justify-content: space-around;
                align-items: center; /* This will vertically center the toolbar items */
                border-right: none;
                border-top: 1px solid #000000;
                padding: 0;
                /* Add blur effect to make it feel more modern */
                background-color: var(--c-header-bg-translucent);
                -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
            }

            .side-toolbar .toolbar-logo {
                display: none; /* Hide logo on bottom bar */
            }

            .toolbar-item {
                padding: 0;
                /* height: 100% is no longer needed as the parent now handles vertical alignment */
                flex-grow: 1; /* Each item takes equal space */
                color: var(--c-text); /* Make icons more prominent on the blurred background */
            }

            .toolbar-item.settings {
                margin-top: 0; /* Reset margin */
            }

            .side-toolbar .settings {
                display: none; /* Hide original settings button on mobile bottom bar */
            }

            .side-toolbar .account-button {
                display: flex; /* Show account button on mobile bottom bar */
            } 
            
            .toolbar-item svg {
                width: 22px; /* Make icons a bit smaller for the mobile bar */
                height: 22px;
            }

            .toolbar-badge {
                top: 10px;
                right: 28px;
                background-color: #e5192d;
                width: 15px;
                border: none;
                height: 15px;
                font-size: 0.7rem; /* Adjust font for smaller badge */
                box-shadow: 0 0 0 2px var(--c-header-bg-translucent); /* Match mobile toolbar background */
            }


        }

        /* Marquee animation shared styles */
        .product-name-desktop h3 span:last-child,
        {
            display: none; /* Hide duplicate text by default */
        }
        .product-name-desktop h3.is-scrolling span:last-child,
        {
            display: inline; /* Show duplicate text only when scrolling */
            padding-left: 2rem; /* Space between repeated text */
        }
            
        @media (max-width: 768px) {
            /* ... existing mobile styles ... */
            .product-card .product-price {
                font-size: 0.7rem; /* Make price font even smaller */
                margin: 0;
                color: #28a745; /* A clear green for the price */
                min-width: 51px;
            }
            .product-card .product-price-line { 
                margin: 0.25rem 0.75rem 0; /* Adjust margin */
                margin-top: auto; /* Push to bottom */
                display: flex;
                gap: 0.5rem; /* Space between price and name */
                overflow: hidden; /* Needed for ellipsis to work on a child */
                min-height: 16px;
            }
            /* Restore consistent image aspect ratio on mobile */
            .product-card img {
                aspect-ratio: 1 / 1;
                height: auto; /* Let aspect-ratio control height */
                border-radius: 9px 9px 4px 4px;
            }
            .product-card .product-location {
                display: none;
            }
            .product-card .product-location svg {
                width: 12px;
                height: 12px;
            }

            .product-grid {
                /* Show ~2.2 cards to fit more on screen */
                grid-auto-columns: 140px; /* Set a fixed width for cards on mobile */
                gap: 1rem; /* Reduce gap slightly on mobile */
                padding: 0 20px 1rem; /* Add horizontal padding and restore bottom padding */
            }

            /* Mobile-specific product name, shown next to the price */
            .product-name-mobile {
                display: block;
                color: var(--c-text); /* Use theme variable for readability */
                font-size: 0.75rem;
                font-size: 0.8rem; /* Slightly larger font */
                font-weight: 500;
                /* Allow title to wrap to two lines */
                white-space: normal;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                /* Truncation for single line */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-grow: 1; /* Allow it to take available space */
            }

            /* Hide the desktop product name on mobile */
            .product-card .product-name-desktop {
                display: none;
            }
        }

    /* ================================================= */
    /*      Progressive Image Loading (Blur-Up)        */
    /* ================================================= */
    .progressive-image {
        aspect-ratio: 1 / 1;
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* Start blurred */
        filter: blur(20px);
        /* Animate the filter property for a smooth "un-blur" */
        transition: filter 0.5s ease-in-out;
    }
    .progressive-image.loaded {
        /* Remove the blur when the 'loaded' class is added */
        filter: blur(0px);
    }



        /* Styles for the new Full Grid View */
        #grid-view-container {
            display: none; /* Hidden by default */
            padding: 2rem 0;
        }

        .full-product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
        }
        /* Style for the "no results" message */
        .full-product-grid .no-results {
            grid-column: 1 / -1; /* Make it span all columns */
            text-align: center;
            color: var(--c-text-secondary);
            padding: 4rem 0;
        }

        @media (max-width: 768px) {
            .full-product-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }

        /* =================================== */
        /*         Skeleton Loader           */
        /* =================================== */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .skeleton {
            background-color: #e0e0e0;
            background-image: linear-gradient(to right, #e0e0e0 0%, #f0f0f0 20%, #e0e0e0 40%, #e0e0e0 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%;
            animation: shimmer 2s linear infinite;
            border-radius: 4px;
        }

        body.dark-theme .skeleton {
            background-color: #2c2c2c;
            background-image: linear-gradient(to right, #2c2c2c 0%, #3a3a3a 20%, #2c2c2c 40%, #2c2c2c 100%);
        }

        .skeleton-card {
            background-color: var(--c-card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--c-shadow);
            display: flex;
            flex-direction: column;
        }

        .skeleton-card .skeleton-img {
            width: 100%;
            aspect-ratio: 1 / 1;
            margin-bottom: 1rem;
        }

        .skeleton-card .skeleton-text {
            height: 1.2rem;
            margin: 0 1rem 0.5rem;
        }

        .skeleton-card .skeleton-text.short {
            width: 60%;
        }

    /* =================================== */
    /*         Account Modal             */
    /* =================================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1200;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    @media (max-width: 500px) {
        .modal-overlay { padding: -1px 1rem; }
    }


    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background-color: var(--c-card-bg);
        padding: 2rem 2.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px var(--c-shadow);
        width: 77%;
        max-width: 400px;
        position: relative;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--c-text-secondary);
        cursor: pointer;
        line-height: 1;
    }

    #signup-form h2 { text-align: center; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--c-text-secondary); text-align: left; }
    .form-group input {
        display: block;
        width: 100%; /* Make input fill the container */
        box-sizing: border-box; /* Ensures padding is included in the width */
        padding: 0.75rem 1rem;
        border: 1px solid var(--c-border);
        border-radius: 8px;
        background-color: var(--c-input-bg);
        color: var(--c-input-text);
        font-size: 1rem;
    }
    .form-group input:focus { outline: 1px solid var(--c-accent); }

    .form-message {
        margin-top: 1rem;
        font-size: 0.9rem;
        min-height: 1.2rem;
        text-align: center;
    }
    .form-message.success { color: #28a745; }
    .form-message.error { color: #dc3545; }

    .form-toggle-link {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: var(--c-text-secondary);
    }
    .form-toggle-link a {
        color: var(--c-accent);
        font-weight: 500;
    }

    .form-group-inline {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .form-group-inline label {
        margin-bottom: 0; /* Override default label margin */
        color: var(--c-text);
        font-weight: normal;
    }
    .form-group-inline input[type="checkbox"] {
        width: auto; /* Override default input width */
    }
 @media (max-width: 500px) {
        .product-card .product-description {
            display: none;
        }
    }
    </style>
    <!--
        NOTE: For a real-world application, many of the styles in this file 
        would be moved to a shared external CSS file to be used by both shop.html and product.html.
        This would avoid code duplication.
    -->
</head>
<body>

    <nav class="side-toolbar" aria-label="Utility navigation">
        <a href="{% if user %}/account{% else %}#{% endif %}" class="toolbar-logo" aria-label="Account">
            {% if user and user.name %}
            <img src="{{ user.photo or 'https://placehold.co/40x40/222831/EEEEEE?text=' + user.name[0]|upper }}" alt="User initial logo">
            {% else %}
            <img src="https://placehold.co/40x40/222831/EEEEEE?text=M&font=sans" alt="MyStore mini logo">
            {% endif %}
        </a>
        <a href="/" id="show-home-view-btn" class="toolbar-item" aria-label="Home View" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </a>
        <button id="show-grid-view-btn" class="toolbar-item" aria-label="Grid View">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        </button>
        {% if user and user.role == 'admin' %}
        <a href="/admin" class="toolbar-item" aria-label="Add Product">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </a>
        {% endif %}
        <a href="/saved" class="toolbar-item" aria-label="Saved Items">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
        </a>
        <a href="/chat" class="toolbar-item" aria-label="Chat with support">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            {% if total_unread_count and total_unread_count > 0 %}
                <span class="toolbar-badge">{{ total_unread_count }}</span>
            {% endif %}
        </a>
        <a href="/account" class="toolbar-item account-button" aria-label="My Account">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </a>
        <!-- This item will be pushed to the bottom on desktop -->
        <a href="/settings" class="toolbar-item settings" aria-label="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </a>
    </nav>

    <header>
        <div class="container" id="header-container">
            <a href="#" class="logo">
                <img src="https://placehold.co/150x40/222831/EEEEEE?text=MyStore&font=sans" alt="MyStore Logo">
            </a>
            <div class="search-container">
                <input type="search" id="search-bar" placeholder="Search for products, brands and more">
                <button type="button" class="cancel-search-btn" aria-label="Cancel search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div class="search-popup">
                    <div class="popup-column">
                        <h4>Top Categories</h4>
                        <ul>
                            <li><a href="#">T-Shirts</a></li>
                            <li><a href="#">Hoodies & Sweatshirts</a></li>
                            <li><a href="#">Jeans & Denim</a></li>
                            <li><a href="#">Jackets & Coats</a></li>
                            <li><a href="#">Sneakers</a></li>
                        </ul>
                    </div>
                    <div class="popup-column">
                        <h4>Popular Brands</h4>
                        <ul>
                            <li><a href="#">Brand A</a></li>
                            <li><a href="#">Brand B</a></li>
                            <li><a href="#">Brand C</a></li>
                            <li><a href="#">Brand D</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="search-icon-mobile" aria-label="Open search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
                <a href="{% if user %}/settings{% else %}#{% endif %}" class="settings-menu-btn" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </a>
            </div>
            <nav id="main-nav">
                <ul>
                    <li><a href="/chat?support=true">Help</a></li>
                    <li><a href="/settings#guide-section">About</a></li>
                    <li><button id="more-btn">More</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Auto-scrolling Category Bar -->
        <section class="category-scroller" aria-label="Product Categories"></section>

        <!-- Featured Product Carousel -->
        <section class="featured-products">
            <div class="carousel-container">
                <div class="carousel-slider">
                    <!-- Carousel items will be injected by JavaScript -->
                </div>
                <div class="carousel-controls">
                    <button class="carousel-btn prev" aria-label="Previous slide">‹</button> 
                    <button class="carousel-btn next" aria-label="Next slide">›</button>
                </div>
                <div class="carousel-pagination">
                    <!-- Pagination dots will be injected by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Product sections will be injected here by JavaScript -->
        <div id="product-sections-container"></div>
            <!--
                Example of a rendered product row:
                <section class="product-row">
                    <div class="container">
                        ...
                    </div>
                </section>
            -->

        <!-- New container for the full grid view -->
        <section id="grid-view-container">
            <div class="container full-product-grid"></div>
        </section>

    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 MyStore. All rights reserved.</p>
        </div>
    </footer>

    <!-- Account Modal -->
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" aria-label="Close">&times;</button>
            <!-- Signup Form -->
            <form id="signup-form">
                <h2>Create Account</h2>
                <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" name="name" placeholder="Your Full Name" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" name="email" placeholder="Your Email Address" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" name="password" placeholder="Your Password" required>
                </div>
                <p class="form-message"></p>
                <button type="submit" class="category-btn" style="width: 100%; border-color: var(--c-accent); color: var(--c-accent);">Create Account</button>
                <p class="form-toggle-link">Already have an account? <a href="#" id="show-login-form">Log In</a></p>
            </form>

            <!-- Login Form (initially hidden) -->
            <form id="login-form" style="display: none;">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" name="email" placeholder="Your Email Address" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" name="password" placeholder="Your Password" required>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="remember-me" name="remember_me">
                    <label for="remember-me">Remember me</label>
                </div>
                <p class="form-message"></p>
                <button type="submit" class="category-btn" style="width: 100%; border-color: var(--c-accent); color: var(--c-accent);">Log In</button>
                <p class="form-toggle-link">Don't have an account? <a href="#" id="show-signup-form">Sign Up</a></p>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Infinite Scroll State ---
            let gridCurrentPage = 1;
            let gridIsLoading = false;
            let gridAllProductsLoaded = false;
            const initialLoadCount = 64; // Fetch 64 products initially for the homepage
            const infiniteScrollCount = 30; // Fetch 30 products for each subsequent infinite scroll
            let isInSearchMode = false;

            // SVG icon for location, defined once for reuse.
            const locationIconRed = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;

            // --- PRICE FORMATTING HELPER ---
            function formatPrice(priceValue) {
                const number = Number(priceValue);
                if (isNaN(number)) {
                    return priceValue; // Return original value if not a number
                }

                // Use Intl.NumberFormat for compact notation (K, M, etc.)
                const formatter = new Intl.NumberFormat('en', {
                    notation: 'compact',
                    compactDisplay: 'short',
                    maximumFractionDigits: 1,
                    minimumFractionDigits: 0
                });

                return formatter.format(number);
            }

            // --- PROGRESSIVE IMAGE LOADING LOGIC ---
            function progressiveImageLoader() {
                const imagesToLoad = document.querySelectorAll('img.progressive-image[data-src]');
                imagesToLoad.forEach(lqipImage => {
                    const highQualitySrc = lqipImage.dataset.src;
                    if (highQualitySrc) {
                        const highQualityImg = new Image();
                        highQualityImg.src = highQualitySrc;
                        highQualityImg.onload = () => {
                            lqipImage.src = highQualitySrc; // Swap the src
                            lqipImage.classList.add('loaded'); // Trigger the un-blur animation
                        };
                    }
                });
            }

            // --- SKELETON LOADER RENDER FUNCTION ---
            function generateSkeletonCardHTML() {
                return `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-img"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text short"></div>
                    </div>`;
            }

            // --- RENDER FUNCTIONS ---
            function generateProductCardHTML(product) {
                // Updated to use the new data structure from the server
                const locationHTML = product.location ? `
                    <div class="product-location">
                        ${locationIconRed}
                        <span>${product.location}</span>
                    </div>
                ` : '';

                const formattedPrice = formatPrice(product.price);
                

                return `
                    <a href="/product?id=${product.id}" class="product-card" data-product-id="${product.id}">
                        <img src="${product.img_lqip}" data-src="${product.img}" class="progressive-image" alt="${product.name}" loading="lazy">
                        <div class="product-name-desktop">
                            <h3>
                                <span>${product.name}</span>
                                <span aria-hidden="true">${product.name}</span>
                            </h3>
                        </div>
                        <p class="product-description">${product.desc}</p>
                        <div class="product-price-line">
                            <p class="product-price">${formattedPrice} XAF</p>
                            <span class="product-name-mobile">${product.name}</span>
                            ${locationHTML}
                        </div>
                    </a>
                `;
            }

            async function initFeaturedCarousel() { // Make it async
                const slider = document.querySelector('.carousel-slider');
                const paginationContainer = document.querySelector('.carousel-pagination');
                const prevBtn = document.querySelector('.carousel-btn.prev');
                const nextBtn = document.querySelector('.carousel-btn.next');
                if (!slider || !paginationContainer || !prevBtn || !nextBtn) return;
    
                try {
                    // 1. Fetch data from the new ads API
                    const response = await fetch('/api/ads');
                    if (!response.ok) throw new Error('Failed to fetch ads');
                    const featuredAds = await response.json();
    
                    if (featuredAds.length === 0) {
                        document.querySelector('.featured-products').style.display = 'none';
                        return;
                    }
    
                    // 2. Render slides and pagination dots
                    // The carousel item is no longer a link. It's just a div.
                    slider.innerHTML = featuredAds.map(ad => `
                        <div class="carousel-item">
                            <img src="${ad.image_url}" alt="${ad.name}">
                            <div class="carousel-caption">
                                <h3>${ad.name}</h3>
                                <p>${ad.description}</p>
                            </div>
                        </div>
                    `).join('');
    
                    paginationContainer.innerHTML = featuredAds.map((_, index) => 
                        `<div class="pagination-dot" data-index="${index}"></div>`
                    ).join('');
    
                    // 3. Initialize carousel logic (this part remains the same)
                    const slides = slider.querySelectorAll('.carousel-item');
                    const dots = paginationContainer.querySelectorAll('.pagination-dot');
                    const totalItems = slides.length;
                    if (totalItems === 0) return;
    
                    let currentIndex = 0;
                    let autoPlayInterval;
    
                    let touchStartX = 0;
                    let touchEndX = 0;
    
                    const handleTouchStart = (e) => {
                        touchStartX = e.touches[0].clientX;
                        stopAutoPlay();
                    };
    
                    const handleTouchMove = (e) => {
                        touchEndX = e.touches[0].clientX;
                    };
    
                    const handleTouchEnd = () => {
                        if (touchStartX - touchEndX > 50) { // Swiped left
                            showSlide((currentIndex + 1) % totalItems);
                        } else if (touchEndX - touchStartX > 50) { // Swiped right
                            showSlide((currentIndex - 1 + totalItems) % totalItems);
                        }
                        startAutoPlay();
                    };
    
                    const showSlide = (index) => {
                        slides.forEach(slide => slide.classList.remove('active'));
                        dots.forEach(dot => dot.classList.remove('active'));
                        slides[index].classList.add('active');
                        dots[index].classList.add('active');
                        slider.style.transform = `translateX(${-index * 100}%)`;
                        currentIndex = index;
                    };
    
                    const startAutoPlay = () => {
                        stopAutoPlay();
                        autoPlayInterval = setInterval(() => {
                            const nextIndex = (currentIndex + 1) % totalItems;
                            showSlide(nextIndex);
                        }, 4000);
                    };
    
                    const stopAutoPlay = () => clearInterval(autoPlayInterval);
    
                    nextBtn.addEventListener('click', () => showSlide((currentIndex + 1) % totalItems));
                    prevBtn.addEventListener('click', () => showSlide((currentIndex - 1 + totalItems) % totalItems));
                    dots.forEach(dot => dot.addEventListener('click', () => showSlide(parseInt(dot.dataset.index))));
                    slider.closest('.carousel-container').addEventListener('mouseenter', stopAutoPlay);
                    slider.closest('.carousel-container').addEventListener('mouseleave', startAutoPlay);
                    slider.addEventListener('touchstart', handleTouchStart, { passive: true });
                    slider.addEventListener('touchmove', handleTouchMove, { passive: true });
                    slider.addEventListener('touchend', handleTouchEnd);
    
                    showSlide(0);
                    startAutoPlay();
    
                } catch (error) {
                    console.error("Failed to initialize featured carousel:", error);
                    document.querySelector('.featured-products').style.display = 'none';
                }
            }

            function renderCategoryScroller(storeData) {
                const scrollerContainer = document.querySelector('.category-scroller');
                if (!scrollerContainer) return;

                const track = document.createElement('div');
                track.className = 'scroller-track';

                const categories = storeData.map(section => section.title);
                
                // Duplicate categories for seamless loop
                const allCategories = [...categories, ...categories];

                allCategories.forEach(title => {
                    const btn = document.createElement('a');
                    // Create a link to the section ID
                    btn.href = `#${title.replace(/[\s&]+/g, '-').toLowerCase()}`;
                    btn.className = 'category-btn';
                    btn.textContent = title;
                    track.appendChild(btn);
                });

                scrollerContainer.appendChild(track);
            }

            function renderStore(storeData) {
                const container = document.getElementById('product-sections-container');
                if (!container) return;

                let allSectionsHTML = '';
                storeData.forEach(section => {
                    const productsHTML = section.products.map(generateProductCardHTML).join('');
                    const sectionId = section.title.replace(/[\s&]+/g, '-').toLowerCase(); // Create a URL-friendly ID
                    allSectionsHTML += `
                        <section class="product-row" id="${sectionId}">
                            <div class="container">
                                <div class="product-row-header">
                                    <h2>${section.title}</h2>
                                </div>
                                <div class="product-grid-container">
                                    <div class="product-grid">${productsHTML}</div>
                                    <button class="scroll-btn prev" aria-label="Scroll left">‹</button>
                                    <button class="scroll-btn next" aria-label="Scroll right">›</button>
                                </div>
                            </div>
                        </section>
                    `;
                });
                container.innerHTML = allSectionsHTML;
            }

            function renderFullGridView(allProducts) {
                const container = document.querySelector('#grid-view-container .full-product-grid');
                if (!container) return;

                if (allProducts.length === 0) {
                    container.innerHTML = `<div class="no-results">
                        <h3>No products found</h3>
                        <p>Try searching for something else.</p>
                    </div>`;
                    return;
                }
                // Re-use the existing card generation function for consistency
                const productsHTML = allProducts.map(generateProductCardHTML).join('');
                container.innerHTML = productsHTML;
            }

            async function loadMoreProducts() {
                // Only load more if we are in grid view and not in a search
                const gridView = document.getElementById('grid-view-container');
                if (gridIsLoading || gridAllProductsLoaded || isInSearchMode || gridView.style.display !== 'block') return;

                gridIsLoading = true;
                // Show skeleton loaders for infinite scroll
                const container = document.querySelector('#grid-view-container .full-product-grid');
                const skeletonHTML = Array(4).fill(generateSkeletonCardHTML()).join('');
                container.insertAdjacentHTML('beforeend', skeletonHTML);

                try {
                    gridCurrentPage++;
                    const response = await fetch(`/api/products?page=${gridCurrentPage}&limit=${infiniteScrollCount}`);
                    if (!response.ok) throw new Error('Failed to fetch more products');
                    
                    const newProducts = await response.json();

                    // Remove the skeleton loaders we just added
                    const skeletonCards = container.querySelectorAll('.skeleton-card');
                    skeletonCards.forEach(card => card.remove());


                    if (newProducts.length === 0) {
                        gridAllProductsLoaded = true;
                        return; // No more products to load
                    }

                    const mappedProducts = newProducts.map(mapProductData);
                    const productsHTML = mappedProducts.map(generateProductCardHTML).join('');
                    
                    container.insertAdjacentHTML('beforeend', productsHTML);

                    initTitleMarquee(); // Re-run on new content for infinite scroll

                } catch (error) {
                    console.error("Failed to load more products:", error);
                } finally {
                    gridIsLoading = false;
                }
            }

            function initTitleMarquee() {
                const titleWrappers = document.querySelectorAll('.product-card .product-name-desktop');

                function checkOverflow() {
                    titleWrappers.forEach(wrapper => {
                        const h3 = wrapper.querySelector('h3');
                        const firstSpan = h3.querySelector('span');
                        const isDesktop = window.innerWidth > 768;

                        // On desktop, apply scrolling if text overflows.
                        // On mobile, this logic is currently disabled by CSS (.product-name-desktop { display: none; })
                        // but this ensures it won't run unnecessarily.
                        if (isDesktop && firstSpan.scrollWidth > wrapper.clientWidth) {
                           h3.classList.add('is-scrolling');
                        } else {
                            // Remove scrolling on mobile or if text doesn't overflow on desktop.
                            h3.classList.remove('is-scrolling');
                        }
                    });
                };

                window.addEventListener('resize', checkOverflow);
                checkOverflow(); // Initial check on load
            }

            // --- DATA FETCHING AND TRANSFORMATION ---
            function mapProductData(product) {
                // Maps a single product from the API format to the client-side format.
                return {
                    img_lqip: product.image_filenames_lqip?.[0] ? `/static/images/${product.image_filenames_lqip[0]}` : 'https://placehold.co/32x32/e9ecef/6c757d',
                    id: product.id, // "000001"
                    name: product.name, // "Vintage Leather Jacket"
                    desc: product.description, // "A stylish vintage leather jacket..."
                    price: product.price, // 150.00
                    location: product.location, // "New York"
                    img: product.image_filenames && product.image_filenames.length > 0 ? `/static/images/${product.image_filenames[0]}` : 'https://placehold.co/500x500/e9ecef/6c757d?text=No+Image',
                    type: product.type || 'Uncategorized', // "Apparel"
                    date_added: product.date_added // "2024-05-15T..."
                };
            }

            function processStoreData(products) {
                // Helper function to map specific types (e.g., "Phone") to general categories (e.g., "Electronics")
                function getGeneralCategory(specificType) {
                    if (!specificType) return 'Other';
                    const sType = specificType.toLowerCase().trim();

                    const categoryKeywords = {
                        'Electronics': ['electronic', 'phone', 'laptop', 'speaker', 'headphone', 'tv', 'camera', 'computer', 'tablet'],
                        'Fashion': ['fashion', 'dress', 'style'],
                        'Apparel': ['apparel', 'cloth', 'shirt', 't-shirt', 'jeans', 'jacket', 'hoodie'],
                        'Footwear': ['shoe', 'sneaker', 'boot', 'sandal'],
                        'Home & Garden': ['home', 'garden', 'furniture', 'decor', 'plant', 'lamp', 'sofa', 'chair'],
                        'Health': ['health', 'wellness', 'supplement', 'vitamin'],
                        'Beauty': ['beauty', 'makeup', 'skincare', 'perfume', 'shampoo', 'cosmetic'],
                        'Sports & Outdoors': ['sport', 'outdoor', 'fitness', 'hiking', 'camping', 'ball'],
                        'Toys & Games': ['toy', 'game', 'puzzle', 'doll', 'boardgame'],
                        'Books & Media': ['book', 'media', 'magazine', 'dvd', 'cd', 'vinyl', 'movie'],
                        'Automotive': ['automotive', 'car', 'motorcycle', 'vehicle', 'tire'],
                        'Groceries & Food': ['grocery', 'food', 'snack', 'drink', 'fruit', 'vegetable'],
                        'Pet Supplies': ['pet', 'dog', 'cat', 'fish', 'animal'],
                        'Office Supplies': ['office', 'stationery', 'pen', 'paper', 'printer'],
                        'Arts & Crafts': ['art', 'craft', 'paint', 'canvas', 'sewing'],
                        'Jewelry & Accessories': ['jewelry', 'accessory', 'watch', 'necklace', 'ring', 'earring'],
                        'Baby Products': ['baby', 'infant', 'diaper', 'stroller'],
                        'Musical Instruments': ['music', 'instrument', 'guitar', 'piano', 'keyboard', 'drum'],
                        'Industrial & Scientific': ['industrial', 'scientific', 'lab', 'tool'],
                        'Real Estate': ['real estate', 'property', 'house', 'apartment', 'land'],
                        'Services': ['service', 'consulting', 'repair', 'cleaning']
                    };

                    for (const generalCategory in categoryKeywords) {
                        if (sType === generalCategory.toLowerCase()) return generalCategory;
                        for (const keyword of categoryKeywords[generalCategory]) {
                            if (sType.includes(keyword)) return generalCategory;
                        }
                    }
                    return 'Other'; // Default category
                }

                // 1. Group all products by their GENERAL category.
                const productsByGeneralCategory = products.reduce((acc, product) => {
                    const generalCategory = getGeneralCategory(product.type);
                    if (product) (acc[generalCategory] = acc[generalCategory] || []).push(product);
                    return acc;
                }, {});
  
                // 2. Create sections from the general categories.
                const allPossibleSections = [];
                const maxSections = 8;

                // Sort categories by the number of products they contain, descending, to show the most popular ones first.
                const sortedCategories = Object.keys(productsByGeneralCategory).sort((a, b) => productsByGeneralCategory[b].length - productsByGeneralCategory[a].length);

                for (const type of sortedCategories) {
                    allPossibleSections.push({ title: type, products: productsByGeneralCategory[type] });
                }

                // 3. Return only the first 8 sections for the homepage view.
                return allPossibleSections.slice(0, maxSections);
            }

            function setView(view) {
                const homeViewElements = [document.querySelector('.featured-products'), document.getElementById('product-sections-container')];
                const gridViewElements = [document.getElementById('grid-view-container')];
                const homeBtn = document.getElementById('show-home-view-btn');
                const gridBtn = document.getElementById('show-grid-view-btn');

                if (view === 'grid') {
                    homeViewElements.forEach(el => el.style.display = 'none');
                    gridViewElements.forEach(el => el.style.display = 'block');
                    homeBtn.style.display = 'flex';
                    gridBtn.style.display = 'none';
                } else { // 'home' view
                    homeViewElements.forEach(el => el.style.display = 'block');
                    gridViewElements.forEach(el => el.style.display = 'none');
                    homeBtn.style.display = 'none';
                    gridBtn.style.display = 'flex';
                }
            }

            async function initializeShop() {
                // --- NEW: Add skeleton loaders immediately on page load ---
                const sectionsContainer = document.getElementById('product-sections-container');
                const gridContainer = document.querySelector('#grid-view-container .full-product-grid');

                if (sectionsContainer && gridContainer) {
                    // Skeleton for home view (product rows)
                    let homeSkeletonHTML = '';
                    for (let i = 0; i < 3; i++) { // Create 3 skeleton rows
                        homeSkeletonHTML += `
                            <section class="product-row">
                                <div class="container">
                                    <div class="product-row-header">
                                        <div class="skeleton" style="width: 200px; height: 2.2rem; margin-bottom: 1rem;"></div>
                                    </div>
                                    <div class="product-grid-container">
                                        <div class="product-grid">
                                            ${Array(6).fill(generateSkeletonCardHTML()).join('')}
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `;
                    }
                    sectionsContainer.innerHTML = homeSkeletonHTML;

                    // Skeleton for full grid view
                    const gridSkeletonHTML = Array(12).fill(generateSkeletonCardHTML()).join('');
                    gridContainer.innerHTML = gridSkeletonHTML;
                }
                // --- END NEW ---
                try {
                    // Fetching from the API endpoint now instead of the static file.
                    // Fetch the first page of products for the initial load.
                    const response = await fetch(`/api/products?page=1&limit=${initialLoadCount}`);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const products = await response.json();

                    // 1. Map and sort all products once
                    // Filter out any null/undefined entries from the source data before mapping
                    // to prevent errors if the JSON data is malformed.
                    const allMappedProducts = products.filter(p => p).map(mapProductData);
                    allMappedProducts.sort((a, b) => new Date(b.date_added) - new Date(a.date_added));

                    // 2. Get data grouped into sections for the default view
                    const storeDataForSections = processStoreData(allMappedProducts);
                    
                    // 3. Render all components for both views
                    initFeaturedCarousel(); // No longer needs storeData
                    renderCategoryScroller(storeDataForSections);
                    renderStore(storeDataForSections);
                    renderFullGridView(allMappedProducts); // Render the (hidden) grid view
                    
                    // 4. Initialize interactive elements
                    initTitleMarquee();
                    progressiveImageLoader(); // Initialize the image loader

                } catch (error) { 
                    console.error("Failed to initialize shop:", error);
                    // Show error message
                    const container = document.getElementById('product-sections-container');
                    if (container) container.innerHTML = `<p style="text-align: center; color: var(--c-text-secondary);">Could not load products. Please try again later.</p>`;
                }
            }

            // Search Bar Popup
            const searchBar = document.getElementById('search-bar');
            const searchPopup = document.querySelector('.search-popup');

            searchBar.addEventListener('focus', () => searchPopup.classList.add('active'));
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.search-container');
                if (!searchContainer.contains(e.target)) {
                    searchPopup.classList.remove('active');
                }
            });

            // Mobile Inline Search
            const mobileSearchIcon = document.querySelector('.search-icon-mobile');
            const cancelSearchBtn = document.querySelector('.cancel-search-btn');
            const headerEl = document.querySelector('header');
            const desktopSearchInput = document.getElementById('search-bar');

            if (mobileSearchIcon && cancelSearchBtn && headerEl) {
                mobileSearchIcon.addEventListener('click', () => {
                    headerEl.classList.add('search-mode-on');
                    desktopSearchInput.focus(); // Use the variable defined above
                });

                cancelSearchBtn.addEventListener('click', () => {
                    headerEl.classList.remove('search-mode-on');
                    desktopSearchInput.value = ''; // Use the variable defined above
                    performSearch(''); // Reset to home view
                });
            }

            // Event Delegation for dynamically added elements
            document.body.addEventListener('click', function(e) {
                // Horizontal Scrolling
                if (e.target.matches('.scroll-btn')) {
                    const grid = e.target.closest('.product-grid-container').querySelector('.product-grid');
                    const scrollAmount = grid.querySelector('.product-card').offsetWidth * 2;
                    const direction = e.target.classList.contains('next') ? 1 : -1;
                    grid.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
                }
            });

            // --- SEARCH LOGIC ---
            let searchTimeout;

            async function performSearch(query) {
                query = query.trim();

                if (query.length === 0) {
                    isInSearchMode = false; // We are no longer in search mode
                    setView('home'); // Go back to home view if search is cleared
                    return;
                }

                isInSearchMode = true; // Set search mode
                // Switch to grid view immediately for better user feedback
                setView('grid');

                // Show skeleton loaders for search
                const gridContainer = document.querySelector('#grid-view-container .full-product-grid');
                const skeletonHTML = Array(12).fill(generateSkeletonCardHTML()).join('');
                gridContainer.innerHTML = skeletonHTML;
                
                // For search, we fetch all results at once. Pagination could be added here too.
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Search request failed');
                    const results = await response.json();
                    
                    // Map results before rendering
                    const mappedResults = results.map(mapProductData);
                    renderFullGridView(mappedResults);
                    initTitleMarquee(); // Re-initialize marquee for new search result cards
                    progressiveImageLoader(); // Initialize loader for search results

                } catch (error) {
                    console.error('Search error:', error);
                    const container = document.querySelector('#grid-view-container .full-product-grid');
                    if (container) {
                        container.innerHTML = `<div class="no-results"><h3>Error performing search</h3><p>Please try again later.</p></div>`;
                    }
                }
            }

            function handleSearchInput(event) {
                clearTimeout(searchTimeout);
                const query = event.target.value;
                // Debounce the search to avoid firing on every keystroke
                searchTimeout = setTimeout(() => { performSearch(query); }, 300); // 300ms delay
            }

            desktopSearchInput?.addEventListener('input', handleSearchInput);

            // View Toggling Event Listeners
            document.getElementById('show-grid-view-btn').addEventListener('click', () => setView('grid'));
            document.getElementById('show-home-view-btn').addEventListener('click', () => setView('home'));

            // New "More" button listener
            const moreBtn = document.getElementById('more-btn');
            if (moreBtn) { // The button now has no class, so we need to style it like a link
                moreBtn.addEventListener('click', () => {
                    setView('grid');
                });
            }
            // Hide header on scroll for better mobile experience
            const header = document.querySelector('header');
            if (header) {
                let lastScrollY = window.scrollY;
                window.addEventListener("scroll", () => {
                    if (window.innerWidth <= 768) { // Only apply on mobile
                        if (lastScrollY < window.scrollY && window.scrollY > header.offsetHeight) {
                            header.classList.add("header--hidden");
                        } else {
                            header.classList.remove("header--hidden");
                        }
                        lastScrollY = window.scrollY < 0 ? 0 : window.scrollY;
                    } else {
                        header.classList.remove("header--hidden"); // Ensure header is visible on desktop
                    }
                });
            }

            // --- THEME APPLICATION LOGIC ---
            // This logic remains to apply the theme set on the settings page.
            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-theme', theme === 'dark');
            };

            // Apply saved theme on load
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            // Listen for theme changes from other tabs/windows
            window.addEventListener('storage', (event) => {
                if (event.key === 'theme' && event.newValue) {
                    applyTheme(event.newValue);
                }
            });

            // --- INITIALIZE THE SHOP ---
            initializeShop();
            
            // --- GENTLE SCROLL ON MOBILE LOAD ---
            setTimeout(() => {
                if (window.innerWidth <= 768) {
                    window.scrollTo({
                        top: 150,
                        behavior: 'smooth'
                    });
                }
            }, 2000); // 2-second delay

            // --- Infinite Scroll Listener ---
            window.addEventListener('scroll', () => {
                // Trigger load when user is 500px from the bottom of the page
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    loadMoreProducts();
                }
            });
        });

        // --- Account Modal Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('account-modal');
            const openModalBtns = document.querySelectorAll('.toolbar-logo, .account-button, .settings-menu-btn');
            const closeModalBtn = modal.querySelector('.modal-close');
            
            const signupForm = document.getElementById('signup-form');
            const loginForm = document.getElementById('login-form');
            
            const showLoginFormBtn = document.getElementById('show-login-form');
            const showSignupFormBtn = document.getElementById('show-signup-form');

            const signupMessage = signupForm.querySelector('.form-message');
            const loginMessage = loginForm.querySelector('.form-message');

            const openModal = (showLogin = false) => {
                modal.classList.add('active'); // This makes the modal visible
                document.body.style.overflow = 'hidden';
                // Default to showing the signup form and hiding the login form
                signupForm.style.display = 'block';
                loginForm.style.display = 'none';

                // If the showLogin flag is true, switch to the login form
                if (showLogin) {
                    signupForm.style.display = 'none';
                    loginForm.style.display = 'block';
                }
            };

            const closeModal = () => {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                signupForm.reset();
                loginForm.reset();
                signupMessage.textContent = '';
                loginMessage.textContent = '';
                signupMessage.className = 'form-message';
                loginMessage.className = 'form-message';
            };

            openModalBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Check if the link is a placeholder for the modal.
                    // This ensures that links like '/settings' for logged-in users work correctly.
                    if (btn.getAttribute('href') === '#') {
                        e.preventDefault(); // Stop the '#' from being added to the URL.
                        openModal();
                    }
                });
            });

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Form switching logic
            showLoginFormBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.style.display = 'none';
                loginForm.style.display = 'block';
            });

            showSignupFormBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            });

            // Signup form submission
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                signupMessage.textContent = '';
                signupMessage.className = 'form-message';

                const formData = new FormData(signupForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/create_user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    const result = await response.json();

                    if (response.status === 201) {
                        signupMessage.textContent = 'Account created successfully! You can now log in.';
                        signupMessage.classList.add('success');
                        setTimeout(() => {
                            // Switch to login form after successful signup
                            signupForm.style.display = 'none';
                            loginForm.style.display = 'block';
                        }, 2000);
                    } else {
                        signupMessage.textContent = result.error || 'An unknown error occurred.';
                        signupMessage.classList.add('error');
                    }
                } catch (error) {
                    signupMessage.textContent = 'Could not connect to the server.';
                    signupMessage.classList.add('error');
                }
            });

            // Login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginMessage.textContent = '';
                loginMessage.className = 'form-message';

                const formData = new FormData(loginForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    const result = await response.json();

                    if (response.ok) {
                        loginMessage.textContent = 'Login successful!';
                        loginMessage.classList.add('success');
                        // Reload the page to reflect the new login state
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        loginMessage.textContent = result.error || 'An unknown error occurred.';
                        loginMessage.classList.add('error');
                    }
                } catch (error) {
                    loginMessage.textContent = 'Could not connect to the server.';
                    loginMessage.classList.add('error');
                }
            });

            // Check for #login hash on page load to open the login modal automatically
            if (window.location.hash === '#login') {
                openModal(true); // Open the modal and show the login form
            }
        });
    </script>


</body>
</html>
